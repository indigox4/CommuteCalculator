<!DOCTYPE html>
<html>
  <head>
    <title>Simple Map</title>
    <meta name="viewport" content="initial-scale=1.0">
    <meta charset="utf-8">
    <style>
      /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */
      #map {
        height: 20%;
      }
      /* Optional: Makes the sample page fill the window. */
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }

      table, th, td {
          border: 1px solid black;
      }      
    </style>
  </head>
  <body>
    <div id="map"></div>
    <div id="time"></div>
    <div id="requests"></div>    
    <script src="https://maps.googleapis.com/maps/api/js"></script>
    <script>
      var map;
      var gMapRequests = [];
      var kPending = 0;
      var kSuccess = 1;
      var kFailure = 2;
      var gPropertyOfInterest = "71 Methuen Ave, York, ON, Canada, M6S 1Z7";

      function MapRequest() {
        this.start = "";
        this.end = "";
        this.index = 0;
        this.mode = google.maps.DirectionsTravelMode.DRIVING;
        this.departTime = new Date('2018-08-20T16:00:00');
        this.bestGuessTime = "";
        this.optimisticTime = "";
        this.pessimisticTime = "";
        this.status = kPending; // 0 - pending, 1 - successful, 2 - failed
      }

      function addRequest( request ) {
        request.index = gMapRequests.length;
        gMapRequests.push( request );
      }

      function startRequest( mapRequest ) {
        addRequest( mapRequest );
        var request = {
          origin: mapRequest.start, 
          destination: mapRequest.end, 
          travelMode: mapRequest.mode
          // drivingOptions: {
  	      //   departureTime: new Date('2018-08-20T19:00:00'),
          //   trafficModel: google.maps.TrafficModel.BEST_GUESS
          // }
        };
        
        var isDriving = (mapRequest.mode === google.maps.DirectionsTravelMode.DRIVING); 
        if( isDriving ) {
          request.drivingOptions = {
            departureTime: mapRequest.departTime,
            trafficModel: google.maps.TrafficModel.BEST_GUESS
          }
        }
        
        var reqIndex = mapRequest.index;

        var directionsService = new google.maps.DirectionsService();
        directionsService.route( request, function( response, status ) {
          if ( status === 'OK' ) {
            var point = response.routes[ 0 ].legs[ 0 ];
            gMapRequests[reqIndex].bestGuessTime = point.duration_in_traffic.text;
            if( !isDriving ) {
              gMapRequests[reqIndex].status = kSuccess;
            }
          } else {
            gMapRequests[reqIndex].status = kFailure;
          }
          refreshUI();
        }); 
        
        if( isDriving ) {
          var request2 = JSON.parse( JSON.stringify(request) );
          request2.drivingOptions.trafficModel = google.maps.TrafficModel.OPTIMISTIC;
          request2.drivingOptions.departureTime = request.drivingOptions.departureTime;

          directionsService.route( request2, function( response, status ) {
            if ( status === 'OK' ) {
              var point = response.routes[ 0 ].legs[ 0 ];
              gMapRequests[reqIndex].optimisticTime = point.duration_in_traffic.text;
            } else {
              gMapRequests[reqIndex].status = kFailure;
            }
            refreshUI();
          }); 

          var request3 = JSON.parse( JSON.stringify(request) );
          request3.drivingOptions.trafficModel = google.maps.TrafficModel.PESSIMISTIC;
          request3.drivingOptions.departureTime = request.drivingOptions.departureTime;

          directionsService.route( request3, function( response, status ) {
            if ( status === 'OK' ) {
              var point = response.routes[ 0 ].legs[ 0 ];
              gMapRequests[reqIndex].pessimisticTime = point.duration_in_traffic.text;
              gMapRequests[reqIndex].status = kSuccess;
            } else {
              gMapRequests[reqIndex].status = kFailure;
            }
            refreshUI();
          });           
        }
      }

      function refreshUI() {
        var html = "<table>";
        html += "<tr><th>From</th><th>To</th><th>Departing at</th><th>Travel time</th></tr>";
        for(i = 0; i < gMapRequests.length; ++i ) {
          html += "<tr>";
          html += "<td>" + gMapRequests[i].start + "</td>";
          html += "<td>" + gMapRequests[i].end + "</td>";
          html += "<td>" + gMapRequests[i].departTime.toLocaleTimeString()  + "</td>";

          if( gMapRequests[i].status === 0 ) {
            html += "<td>Calculating</td>";

          } else if( gMapRequests[i].status === 1 ) {
            html += "<td>" + gMapRequests[i].bestGuessTime 
                    + " (" + gMapRequests[i].optimisticTime + " - " 
                    + gMapRequests[i].pessimisticTime + ")</td>";
          } else {
            html += "<td>Dunno!</td>";
          }
        }
        html += "</table>";
        document.getElementById('requests').innerHTML = html;
      }

      function initMap() {

        var req = new MapRequest();
        req.start = gPropertyOfInterest;
        req.end = "7120 Hurontario St, Mississauga, ON L5S 1Z8";
        req.departTime = new Date('2018-08-20T08:00:00');
        startRequest( req );

        var req2 = new MapRequest();
        req2.start = req.end;
        req2.end = req.start;
        req2.departTime = new Date('2018-08-20T16:30:00');
        startRequest( req2 );

        refreshUI();

        map = new google.maps.Map(document.getElementById('map'), {
          center: {lat: -25.344, lng: 131.036},
          zoom: 8
        });
        
        // center the map around the property of interest
        var coder = new google.maps.Geocoder();
        var coderReq = {
          address: gPropertyOfInterest
        };
        coder.geocode( coderReq, function(results, status) {
          if( status === 'OK' ) {
            map.setCenter( results[0].geometry.location );
            map.setZoom(15);

            var markerOpts = {
              map: map,
              position: results[0].geometry.location
            };
            var marker = new google.maps.Marker( markerOpts )
          }
        });


      }

    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD3MaQdE7XUHMs8ibUkSDRJM0CimlaPiXI&callback=initMap"
    async defer></script>
  </body>
</html>